<?php

class ExploitationController extends Zend_Controller_Action
{
    public function indexAction()
    {

        $date = time();

        $tableVol = new TVols;

        //Recherche touts les vol qui sont en cour ( deja partie , mais pas ecore arriver )
        $selectvols = $tableVol->select()->where('heure_dep <= ?',$date)->where('heure_arr >= ?',$date);
        $vols = $tableVol->fetchAll($selectvols);


        $tab_vol = array();
        $count = 0;

        //BOucle sur chaque vol de la table 
        foreach ($vols as $vol) {

            // Recupere toutes les infos du vol
            $tableDestination = new TDestination;
            $destination = $tableDestination->find($vol->id_destination)->current();

            $tableAeroport = new TAeroport;
            $aeroport = $tableAeroport->find($destination->tri_aero_dep)->current();
            $aeroportBis = $tableAeroport->find($destination->tri_aero_arr)->current();

            $tableVille = new TVille;
            $ville = $tableVille->find($aeroport->id_ville)->current();
            $villeBis = $tableVille->find($aeroportBis->id_ville)->current();

            $tablePays = new TPays;
            $pays = $tablePays->find($ville->id_pays)->current();
            $paysBis = $tablePays->find($villeBis->id_pays)->current();

            $tablePilote = new TPilote;
            $pilote = $tablePilote->find($vol->id_pilote)->current();
            $copilote = $tablePilote->find($vol->id_copilote)->current();

            $tableUtilisateur = new TUtilisateur;
            $utilisateur = $tableUtilisateur->find($pilote->id_utilisateur)->current();
            $utilisateurBis = $tableUtilisateur->find($copilote->id_utilisateur)->current();

            $tableAvion = new TAvion;
            $avion = $tableAvion->find($vol->immatriculation)->current();

            $tableModelAvion = new TModelAvion;
            $modelAvion = $tableModelAvion->find($avion->id_model)->current();

            // Reunie toutes les informations dans un seul meme tableau pour simplifier l'envoie vers la vue.
            $tab_vol[$count]['numero_vol']              = $destination->numero_vol;
            $tab_vol[$count]['id_vol']                  = $vol->id_vols;
            $tab_vol[$count]['heur_depart']             = $vol->heure_dep;
            $tab_vol[$count]['aeroport_depart']         = $aeroport->nom_aeroport;
            $tab_vol[$count]['ville_depart']            = $ville->nom_ville;
            $tab_vol[$count]['pays_depart']             = $pays->nom_pays;
            $tab_vol[$count]['heur_arrive']             = $vol->heure_arr;
            $tab_vol[$count]['aeroport_arrive']         = $aeroportBis->nom_aeroport;
            $tab_vol[$count]['ville_arrive']            = $villeBis->nom_ville;
            $tab_vol[$count]['pays_arrive']             = $paysBis->nom_pays;
            $tab_vol[$count]['pilotes']                 = $utilisateur->nom_utilisateur.' '.$utilisateur->prenom_utilisateur;
            $tab_vol[$count]['co_pilotes']              = 'Co-Pilote: '.$utilisateurBis->nom_utilisateur.' '.$utilisateurBis->prenom_utilisateur;
            $tab_vol[$count]['avion_model']             = $modelAvion->nom_model;
            $tab_vol[$count]['avion_immatriculation']   = $avion->immatriculation;
            $tab_vol[$count]['remarque']                = $vol->remarque;

            $count++;
        }
        $this->view->listevol = $tab_vol;
        
    }

    public function modifierremarqueAction()
    {

        $id_vols    = $this->_getParam('id');

        $tableVol = new TVols;
        $selectvols = $tableVol->select()->where('id_vols = ?',$id_vols)->order();
        $vols = $tableVol->fetchAll($selectvols)->toArray();

        $remarque =  array( 'remarque' => $vols[0]['remarque'] );

        $formModifierRemarqueVol = new FModifierRemarqueVol;
        $formModifierRemarqueVol->populate($remarque);
        $this->view->formModifierRemarqueVol = $formModifierRemarqueVol;

        if ($this->_request->isPost()) {
            $formData = $this->_request->getPost();

            if ($formModifierRemarqueVol->isValid($formData)) {

                $date =time();

                // Verifie si la modification ce porte bien a un vol en cour 
                if ($vols[0]['heure_dep'] <= $date &&   $vols[0]['heure_arr'] >= $date ) {

                    
                    $where = $tableVol->getAdapter()->quoteInto('id_vols = ?', $id_vols );
                    $tableVol->update( array( 'remarque'   => $formModifierRemarqueVol->getValue('remarque')),$where);  

                    $redirector = $this->_helper->getHelper('Redirector');
                    $redirector->gotoUrl('exploitation/index');

                }else{
                    echo 'Impossible de modifier un vol qui n\'est pas en vol ! ';
                }

            }
        }
    }

    public function listeavionsfiniAction()
    {
        $date = time();

        $tableVol = new TVols;
        //Recherche touts les vol qui sont fini et non valider
        $selectvols = $tableVol->select()->where('heure_arr <= ?',$date)->where('valider = 0')->order('heure_arr');
        
        $vols = $tableVol->fetchAll($selectvols);


        $tab_vol = array();
        $count = 0;

        //BOucle sur chaque vol de la table 
        foreach ($vols as $vol) {

            // Recupere toutes les infos du vol
            $tableDestination = new TDestination;
            $destination = $tableDestination->find($vol->id_destination)->current();

            $tableAeroport = new TAeroport;
            $aeroport = $tableAeroport->find($destination->tri_aero_dep)->current();
            $aeroportBis = $tableAeroport->find($destination->tri_aero_arr)->current();

            $tableVille = new TVille;
            $ville = $tableVille->find($aeroport->id_ville)->current();
            $villeBis = $tableVille->find($aeroportBis->id_ville)->current();

            $tablePays = new TPays;
            $pays = $tablePays->find($ville->id_pays)->current();
            $paysBis = $tablePays->find($villeBis->id_pays)->current();

            $tablePilote = new TPilote;
            $pilote = $tablePilote->find($vol->id_pilote)->current();
            $copilote = $tablePilote->find($vol->id_copilote)->current();

            $tableUtilisateur = new TUtilisateur;
            $utilisateur = $tableUtilisateur->find($pilote->id_utilisateur)->current();
            $utilisateurBis = $tableUtilisateur->find($copilote->id_utilisateur)->current();

            $tableAvion = new TAvion;
            $avion = $tableAvion->find($vol->immatriculation)->current();

            $tableModelAvion = new TModelAvion;
            $modelAvion = $tableModelAvion->find($avion->id_model)->current();

            // Reunie toutes les informations dans un seul meme tableau pour simplifier l'envoie vers la vue.
            $tab_vol[$count]['numero_vol']              = $destination->numero_vol;
            $tab_vol[$count]['id_vol']                  = $vol->id_vols;
            $tab_vol[$count]['heur_depart']             = $vol->heure_dep;
            $tab_vol[$count]['aeroport_depart']         = $aeroport->nom_aeroport;
            $tab_vol[$count]['ville_depart']            = $ville->nom_ville;
            $tab_vol[$count]['pays_depart']             = $pays->nom_pays;
            $tab_vol[$count]['heur_arrive']             = $vol->heure_arr;
            $tab_vol[$count]['aeroport_arrive']         = $aeroportBis->nom_aeroport;
            $tab_vol[$count]['ville_arrive']            = $villeBis->nom_ville;
            $tab_vol[$count]['pays_arrive']             = $paysBis->nom_pays;
            $tab_vol[$count]['pilotes']                 = $utilisateur->nom_utilisateur.' '.$utilisateur->prenom_utilisateur;
            $tab_vol[$count]['co_pilotes']              = 'Co-Pilote: '.$utilisateurBis->nom_utilisateur.' '.$utilisateurBis->prenom_utilisateur;
            $tab_vol[$count]['avion_model']             = $modelAvion->nom_model;
            $tab_vol[$count]['avion_heure_vol_total']   = $avion->heure_vol_total;
            $tab_vol[$count]['remarque']                = $vol->remarque;

            $count++;
        }
        $this->view->listevol = $tab_vol;
    }

    public function validervolAction()
    {
        //Recupere immatriculation avec l'url
        $id_vol    = $this->_getParam('id');

        $tableVol = new TVols;
        //Recherche le vol
        $selectvols = $tableVol->select()->where('id_vols = ?',$id_vol);
        $vol = $tableVol->fetchRow($selectvols);

        if ($vol['valider'] == 0) {

            //recherche l'avion corespondent avec l'immatriculaton
            $tableAvion    = new TAvion;
            $selectAvion   = $tableAvion ->select()->where('immatriculation = ?',$vol['immatriculation']  );
            $avion         = $tableAvion->fetchRow($selectAvion);   

            $formValiderVolFini = new FValiderVolFini;

            $dataform = array(  'datepickerdeb' => date("d-m-Y",$vol['heure_dep']),
                                'timepickerdeb' => date("H:i",$vol['heure_dep']),
                                'datepickerarr' => date("d-m-Y",$vol['heure_arr']),
                                'timepickerarr' => date("H:i",$vol['heure_arr']),
                                'remarque' => $vol['remarque'] );

            $formValiderVolFini->populate($dataform);
            $this->view->formValiderVolFini = $formValiderVolFini;

            if ($this->_request->isPost()) {
                $formData = $this->_request->getPost();

                if ($formValiderVolFini->isValid($formData)) {

                        //Recupere l'heure du formulaire en timestamps

                            list($jour_deb, $mois_deb, $annee_deb)  = explode("-", $formValiderVolFini->getValue('datepickerdeb') );
                            list($heure_deb, $minute_deb)  = explode(":", $formValiderVolFini->getValue('timepickerdeb') );
                            $date_deb                    = mktime($heure_deb , $minute_deb, 0, $mois_deb, $jour_deb, $annee_deb);

                            list($jour_arr, $mois_arr, $annee_arr)  = explode("-", $formValiderVolFini->getValue('datepickerarr') );
                            list($heure_arr, $minute_arr)  = explode(":", $formValiderVolFini->getValue('timepickerarr') );
                            $date_arr                    = mktime($heure_arr , $minute_arr, 0, $mois_arr, $jour_arr, $annee_arr);

                            $remarque               = $formValiderVolFini->getValue('remarque');

                        // calcule du nombre d'heur du vol

                            $temps = $date_arr - $date_deb;

                            //Calcule le nombre d'heure

                            $heure = (intval($temps / 3600))+1;

        
                            echo $temps.' - '.$heure;
                

                        //Ajoute le nombre d'heures a l'avion

                            // Calcul le nombre d'heur total ( Ancienne Heure + le nombre d'heures en plus )
                            $heure_vol_total        = $avion['heure_vol_total']+$heure;
                            $heure_depuis_revision  = $avion['heure_depuis_revision']+$heure;

                            // Update du nombre d'heures total et depuis la derniere revision pour l'immatriculation selectionner
                            $where = $tableAvion->getAdapter()->quoteInto('immatriculation = ?', $vol['immatriculation'] );
                            $tableAvion->update( array( 'heure_vol_total'           =>  ($heure_vol_total) ,
                                                        'heure_depuis_revision'     =>    ($heure_depuis_revision)  ),$where);  

                        //Ajoute le nombre d'heures aux pilotes

                            $tableTempsTravail = new TTempsTravail;
                             
                            $dataPilot = array(
                                'id_pilote'      => $vol['id_pilote'],
                                'date' => time(),
                                'temps'      => $temps
                            );

                            $dataCo_Pilot = array(
                                'id_pilote'      => $vol['id_copilote'],
                                'date' => time(),
                                'temps'      => $temps 
                            );
                        
                            $tableTempsTravail->insert($dataPilot);
                            $tableTempsTravail->insert($dataCo_Pilot);

                        // Modifier le vol

                            $where = $tableVol->getAdapter()->quoteInto('id_vols = ?',$id_vol );
                            $tableVol->update( array(   'heure_dep'    =>  $date_deb ,
                                                        'heure_arr'    =>  $date_arr ,
                                                        'valider'    =>  1 ,
                                                        'remarque'     =>    $remarque  ),$where); 


                        $redirector = $this->_helper->getHelper('Redirector');
                        $redirector->gotoUrl('exploitation/listeavionsfini');
                }
            }
        }
    }

    public function menuexploitationAction()
    {

    }
    
}