<?php

class ExploitationController extends Zend_Controller_Action
{
	public function indexAction()
    {

        $date = time();

        $tableVol = new TVols;

        //Recherche touts les vol qui sont en cour ( deja partie , mais pas ecore arriver )
        $selectvols = $tableVol->select()->where('heure_dep <= ?',$date)->where('heure_arr >= ?',$date);
        $vols = $tableVol->fetchAll($selectvols);


        $tab_vol = array();
        $count = 0;

        //BOucle sur chaque vol de la table 
        foreach ($vols as $vol) {

            // Recupere toutes les infos du vol
            $tableDestination = new TDestination;
            $destination = $tableDestination->find($vol->id_destination)->current();

            $tableAeroport = new TAeroport;
            $aeroport = $tableAeroport->find($destination->tri_aero_dep)->current();
            $aeroportBis = $tableAeroport->find($destination->tri_aero_arr)->current();

            $tableVille = new TVille;
            $ville = $tableVille->find($aeroport->id_ville)->current();
            $villeBis = $tableVille->find($aeroportBis->id_ville)->current();

            $tablePays = new TPays;
            $pays = $tablePays->find($ville->id_pays)->current();
            $paysBis = $tablePays->find($villeBis->id_pays)->current();

            $tablePilote = new TPilote;
            $pilote = $tablePilote->find($vol->id_pilote)->current();
            $copilote = $tablePilote->find($vol->id_copilote)->current();

            $tableUtilisateur = new TUtilisateur;
            $utilisateur = $tableUtilisateur->find($pilote->id_utilisateur)->current();
            $utilisateurBis = $tableUtilisateur->find($copilote->id_utilisateur)->current();

            $tableAvion = new TAvion;
            $avion = $tableAvion->find($vol->immatriculation)->current();

            $tableModelAvion = new TModelAvion;
            $modelAvion = $tableModelAvion->find($avion->id_model)->current();

            // Reunie toutes les informations dans un seul meme tableau pour simplifier l'envoie vers la vue.
            $tab_vol[$count]['numero_vol']              = $destination->numero_vol;
            $tab_vol[$count]['id_vol']                  = $vol->id_vols;
            $tab_vol[$count]['heur_depart']             = $vol->heure_dep;
            $tab_vol[$count]['aeroport_depart']         = $aeroport->nom_aeroport;
            $tab_vol[$count]['ville_depart']            = $ville->nom_ville;
            $tab_vol[$count]['pays_depart']             = $pays->nom_pays;
            $tab_vol[$count]['heur_arrive']             = $vol->heure_arr;
            $tab_vol[$count]['aeroport_arrive']         = $aeroportBis->nom_aeroport;
            $tab_vol[$count]['ville_arrive']            = $villeBis->nom_ville;
            $tab_vol[$count]['pays_arrive']             = $paysBis->nom_pays;
            $tab_vol[$count]['pilotes']                 = $utilisateur->nom_utilisateur.' '.$utilisateur->prenom_utilisateur;
            $tab_vol[$count]['co_pilotes']              = 'Co-Pilote: '.$utilisateurBis->nom_utilisateur.' '.$utilisateurBis->prenom_utilisateur;
            $tab_vol[$count]['avion_model']             = $modelAvion->nom_model;
            $tab_vol[$count]['avion_immatriculation']   = $avion->immatriculation;
            $tab_vol[$count]['remarque']                = $vol->remarque;

            $count++;
        }
        $this->view->listevol = $tab_vol;
    	
    }

    public function modifierremarqueAction()
    {

        $id_vols    = $this->_getParam('id');

        $tableVol = new TVols;
        $selectvols = $tableVol->select()->where('id_vols = ?',$id_vols);
        $vols = $tableVol->fetchAll($selectvols)->toArray();

        $remarque =  array( 'remarque' => $vols[0]['remarque'] );

        $formModifierRemarqueVol = new FModifierRemarqueVol;
        $formModifierRemarqueVol->populate($remarque);
        $this->view->formModifierRemarqueVol = $formModifierRemarqueVol;

        if ($this->_request->isPost()) {
            $formData = $this->_request->getPost();

            if ($formModifierRemarqueVol->isValid($formData)) {

                $date =time();

                // Verifie si la modification ce porte bien a un vol en cour 
                if ($vols[0]['heure_dep'] <= $date &&   $vols[0]['heure_arr'] >= $date ) {

                    
                    $where = $tableVol->getAdapter()->quoteInto('id_vols = ?', $id_vols );
                    $tableVol->update( array( 'remarque'   => $formModifierRemarqueVol->getValue('remarque')),$where);  

                    $redirector = $this->_helper->getHelper('Redirector');
                    $redirector->gotoUrl('exploitation/index');

                }else{
                    echo 'Impossible de modifier un vol qui n\'est pas en vol ! ';
                }

            }
        }
    }

    public function listeheursavionsAction()
    {

        $tableAvion = new TAvion;
        //Recupere toutes la liste des avion en les organisent pas le nombre d'heur le plus elevÃ© en 1er
        $fetchAllavion = $tableAvion->fetchAll(null,'heure_vol_total DESC');

        //Boucle sur chaque avion
        foreach ($fetchAllavion as $avion) {

            //Recupere le nom du model avec son id
            $tableModelAvion    = new TModelAvion;
            $selectModelAvion   = $tableModelAvion  ->select()
                                                    ->from( array('a' => 'model_avion'),
                                                            array('a.id_model','a.nom_model'))
                                                    ->where('a.id_model = ?',$avion['id_model'] );
            $modelavion         = $tableModelAvion->fetchRow($selectModelAvion);          

            //Remet toutes les info dans un meme tableau
            $listeavion[]   = array('nom_model'             => $modelavion['nom_model']
                                , 'immatriculation'         => $avion['immatriculation']
                                , 'heure_vol_total'         => $avion['heure_vol_total']);
        }
        $this->view->avion     = $listeavion;

    }

    public function ajouterheursavionAction()
    {
        //Recupere immatriculation avec l'url
        $immatriculation    = $this->_getParam('immatriculation');

        //recherche l'avion corespondent avec l'immatriculaton
        $tableAvion    = new TAvion;
        $selectAvion   = $tableAvion ->select()->where('immatriculation = ?',$immatriculation  );
        $avion         = $tableAvion->fetchRow($selectAvion);   

        $formModifierHeursAvion = new FModifierHeursAvion;
        $this->view->formModifierHeursAvion = $formModifierHeursAvion;

        if ($this->_request->isPost()) {
            $formData = $this->_request->getPost();

            if ($formModifierHeursAvion->isValid($formData)) {

                    //Recupere l'heure du formulaire
                    $addheurs               = $formModifierHeursAvion->getValue('heurs');

                    // Calcul le nombre d'heur total ( Ancienne Heure + le nombre d'heures en plus )
                    $heure_vol_total        = $avion['heure_vol_total']+$addheurs;
                    $heure_depuis_revision  = $avion['heure_depuis_revision']+$addheurs;

                    // Update du nombre d'heures total et depuis la derniere revision pour l'immatriculation selectionner
                    $where = $tableAvion->getAdapter()->quoteInto('immatriculation = ?', $immatriculation );
                    $tableAvion->update( array( 'heure_vol_total'           =>  $heure_vol_total ,
                                                'heure_depuis_revision'     =>    $heure_depuis_revision  ),$where);  

                    $redirector = $this->_helper->getHelper('Redirector');
                    $redirector->gotoUrl('exploitation/listeheursavions');

            }
        }

    }

    public function ajouterheuredevolpiloteAction()
    {

    }
    
}